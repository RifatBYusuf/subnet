<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Subnetting Solver (with optional growth)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f8f9fa; }
    table { background:#fff; }
  </style>
</head>
<body>
  <div class="container py-5">
    <h1 class="text-center mb-4">Subnetting Exercise Solver</h1>

    <!-- Input Form -->
    <div class="card p-4 mb-4">
      <form id="subnetForm">
        <div class="mb-3">
          <label class="form-label">Network Block (CIDR)</label>
          <input type="text" class="form-control" id="networkBlock" placeholder="e.g. 135.110.200.128/25" required>
        </div>

        <div id="hostsContainer">
          <label class="form-label">Host Requirements</label>
          <div class="input-group mb-2">
            <input type="text" class="form-control hostName" placeholder="Role (e.g. Admin Team)" required>
            <input type="number" class="form-control hostInput" placeholder="Hosts (e.g. 7)" required>
            <input type="number" class="form-control growthInput" placeholder="Growth % (optional)">
            <button class="btn btn-danger removeHost" type="button">Remove</button>
          </div>
        </div>

        <button type="button" class="btn btn-secondary mb-3" id="addHost">+ Add Another Requirement</button>
        <br>
        <button type="submit" class="btn btn-primary">Calculate Subnets</button>
      </form>
    </div>

    <!-- Results -->
    <h3>Results</h3>
    <div id="results"></div>
  </div>

  <script>
    const addHostBtn = document.getElementById("addHost");
    const hostsContainer = document.getElementById("hostsContainer");

    addHostBtn.addEventListener("click", () => {
      const div = document.createElement("div");
      div.className = "input-group mb-2";
      div.innerHTML = `
        <input type="text" class="form-control hostName" placeholder="Role (e.g. Sales)" required>
        <input type="number" class="form-control hostInput" placeholder="Hosts (e.g. 10)" required>
        <input type="number" class="form-control growthInput" placeholder="Growth % (optional)">
        <button class="btn btn-danger removeHost" type="button">Remove</button>
      `;
      hostsContainer.appendChild(div);

      div.querySelector(".removeHost").addEventListener("click", () => div.remove());
    });

    // Calculate subnets
    document.getElementById("subnetForm").addEventListener("submit", function(e) {
      e.preventDefault();

      const networkBlock = document.getElementById("networkBlock").value.trim();
      const [baseIp, prefixStr] = networkBlock.split("/");
      let baseParts = baseIp.split(".").map(x => parseInt(x));
      let base = (baseParts[0]<<24) + (baseParts[1]<<16) + (baseParts[2]<<8) + baseParts[3];

      let hostEntries = Array.from(document.querySelectorAll(".input-group"))
        .map(group => {
          let hosts = parseInt(group.querySelector(".hostInput").value);
          let growthField = group.querySelector(".growthInput").value;
          let growth = growthField ? parseInt(growthField) : 0;

          let adjusted = hosts;
          let future = null;
          if (growth > 0) {
            let grown = hosts * (1 + growth/100);
            adjusted = (grown - Math.floor(grown) > 0.5)
              ? Math.ceil(grown)
              : Math.floor(grown);
            future = adjusted;
          }

          return {
            name: group.querySelector(".hostName").value,
            hosts,
            growth,
            adjusted,
            future
          };
        })
        .sort((a,b) => b.adjusted - a.adjusted);

      let tableHTML = `
        <table class="table table-bordered table-striped">
          <thead class="table-dark">
            <tr>
              <th>Role</th>
              <th>Prefix</th>
              <th>Network Address</th>
              <th>Broadcast Address</th>
              <th>Valid Host Range</th>
              <th># Spare IPs</th>
            </tr>
          </thead>
          <tbody>
      `;

      let currentBase = base;
      for (let entry of hostEntries) {
        let h = entry.adjusted;
        let bits = 0;
        while ((2**bits) - 2 < h) bits++;
        let blockSize = 2**bits;
        let newPrefix = 32 - bits;

        let netAddr = intToIp(currentBase);
        let bcastAddr = intToIp(currentBase + blockSize - 1);
        let firstHost = intToIp(currentBase + 1);
        let lastHost = intToIp(currentBase + blockSize - 2);
        let usableHosts;
        if (newPrefix === 31) {
          usableHosts = 2; // Point-to-point link
        } else if (newPrefix === 32) {
          usableHosts = 1; // Host route
        } else {
          usableHosts = blockSize - 2; // Normal subnet
        }
        let spare = usableHosts - h;

        let roleLabel;
        if (entry.growth > 0) {
          roleLabel = `${entry.name} (${entry.hosts} â†’ ${entry.future} with ${entry.growth}% growth)`;
        } else {
          roleLabel = `${entry.name} (${entry.hosts})`;
        }

        tableHTML += `
          <tr>
            <td>${roleLabel}</td>
            <td>/${newPrefix}</td>
            <td>${netAddr}</td>
            <td>${bcastAddr}</td>
            <td>${firstHost} - ${lastHost}</td>
            <td>${usableHosts} - ${h} = ${spare}</td>
          </tr>
        `;

        currentBase += blockSize;
      }

      tableHTML += `</tbody></table>`;
      document.getElementById("results").innerHTML = tableHTML;
    });

    function intToIp(int) {
      return ((int>>>24)&255) + "." + ((int>>>16)&255) + "." + ((int>>>8)&255) + "." + (int&255);
    }
  </script>
</body>
</html>
